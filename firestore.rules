rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function roomDoc(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId));
    }

    function isRoomMember(roomId) {
      return isSignedIn() && (request.auth.uid in roomDoc(roomId).data.members);
    }

    match /rooms/{roomId} {
      // ルーム作成: members=[自分] のみ許可
      allow create: if isSignedIn()
        && request.resource.data.members is list
        && request.resource.data.members.size() == 1
        && request.resource.data.members[0] == request.auth.uid;

      // 読み取り: 参加者のみ
      allow read: if isSignedIn() && (request.auth.uid in resource.data.members);

      // 更新: 参加者が、membersに自分を追加する（最大2人）場合のみ
      allow update: if isSignedIn()
        && (request.auth.uid in resource.data.members)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['members'])
        && request.resource.data.members is list
        && request.resource.data.members.size() <= 2
        && request.resource.data.members.hasAll(resource.data.members)
        && (
          request.resource.data.members == resource.data.members
          || (
            request.resource.data.members.size() == resource.data.members.size() + 1
            && (request.auth.uid in request.resource.data.members)
          )
        );

      allow delete: if false;
    }

    match /rooms/{roomId}/events/{eventId} {
      // イベント作成: 参加者のみ。senderIdは本人uid。countは1..9、または長押し時はcount==0かつlongVibration==true。
      allow create: if isRoomMember(roomId)
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.count is int
        && (
          (request.resource.data.count >= 1 && request.resource.data.count <= 9)
          || (request.resource.data.count == 0 && request.resource.data.get('longVibration', false) == true)
        );

      // 読み取り: 参加者のみ
      allow read: if isRoomMember(roomId);

      allow update, delete: if false;
    }
  }
}

