rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function roomDoc(roomId) {
      return get(/databases/$(database)/documents/rooms/$(roomId));
    }

    function isRoomMember(roomId) {
      return isSignedIn() && (request.auth.uid in roomDoc(roomId).data.members);
    }

    match /rooms/{roomId} {
      // ルーム作成: members=[自分] のみ許可
      allow create: if isSignedIn()
        && request.resource.data.members is list
        && request.resource.data.members.size() == 1
        && request.resource.data.members[0] == request.auth.uid;

      // 読み取り: 認証済みユーザー（参加判定や存在チェックのため全認証ユーザーに許可）
      allow read: if isSignedIn();

      // 更新: (1)参加者が自分を追加 (2)既存メンバーが退室で自分を除く（人数制限なし）
      allow update: if isSignedIn()
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['members'])
        && request.resource.data.members is list
        && (
          // (1) 新規参加: 自分を1人だけ追加（自分は元の members にいない）
          (request.resource.data.members.size() == resource.data.members.size() + 1
            && request.resource.data.members.hasAll(resource.data.members)
            && (request.auth.uid in request.resource.data.members)
            && !(request.auth.uid in resource.data.members))
          || (
            // (2) 退室: 既に参加している人が自分だけを members から除く
            (request.auth.uid in resource.data.members)
            && resource.data.members.hasAll(request.resource.data.members)
            && resource.data.members.size() == request.resource.data.members.size() + 1
            && !(request.auth.uid in request.resource.data.members)
          )
        );

      allow delete: if false;
    }

    match /rooms/{roomId}/events/{eventId} {
      // イベント作成: 参加者のみ。senderIdは本人uid。countは1..9、または長押し時はcount==0かつlongVibration==true。
      allow create: if isRoomMember(roomId)
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.count is int
        && (
          (request.resource.data.count >= 1 && request.resource.data.count <= 9)
          || (request.resource.data.count == 0 && request.resource.data.get('longVibration', false) == true)
        );

      // 読み取り: 参加者のみ
      allow read: if isRoomMember(roomId);

      allow update, delete: if false;
    }
  }
}

